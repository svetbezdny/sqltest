## Find the average client activity time

_Find the average client activity time (time between the dates of the first and last rental) in days._  
_Display the result in the avg-life-time field, rounding it to an integer_

```sql
select round(avg(diff)) as avg_life_time from (
    select
     datediff(max(rental_date), min(rental_date)) as diff
    from customer c
    join rental r on c.customer_id = r.customer_id
    group by c.customer_id
)t
```

## Find the average revenue

_Find the average amount of revenue brought in by each paying customer_  
_Display the result in the avg-customer-payment field, rounding it to two decimal places_

```sql
select round(avg(amnt), 2) as avg_customer_payment from (
    select
     c.customer_id,
     sum(amount) as amnt
    from customer c
    join payment p on c.customer_id = p.customer_id
    group by 1
)t
```

## Find the store average revenue

_Find the average amount of revenue generated by each paying client for each rental store_  
_Display the result in two columns store-id and avg-customer-payment, rounding the amount to two decimal places, sort the result by store number_

```sql
select
 store_id,
 round(avg(amt), 2) as avg_customer_payment
from (
    select
     store_id,
     c.customer_id,
     sum(amount) as amt
    from customer c
    join payment p on c.customer_id = p.customer_id
    group by 1, 2
)t
group by 1
order by 1
```

## Analyze monthly payment

_Write query calculate the total payment amount for each month and display the results in descending order based on the payment month._  
_The query should return only two columns: payment-month - The month of the payment (formatted as "YYYY-MM") and payment-amount - The total payment amount for each month._

```sql
select
 date_format(payment_date, '%Y-%m') as payment_month,
 sum(amount) payment_amount
from payment
group by 1
order by 1 desc
```

## Analyze monthly payments (2)

_Write a request to calculate the amount of payments for each month of 2005 and the cumulative amount from the beginning of the year._  
_The query should return three columns: payment-month – month of payment (in “YYYY-MM” format), monthly-amount – total amount of payments for month and yearly-amount – amount since the beginning of the year_

```sql
select
 date_format(payment_date, '%Y-%m') as payment_month,
 sum(amount) monthly_amount,
 sum(sum(amount)) over(rows between unbounded preceding and current row) as yearly_amount
from payment
where year(payment_date) = 2005
group by 1
```

## Find movie popularity rating

_Write a request to construct a rating of the popularity of films (by the number of copies rented) in 2005._  
_Get the top three places in the rating (if several films have the same rating, print them all)._  
_Present the result as table of two columns film-rank and film-title_

```sql
select
 film_rank,
 film_title
from (
 select
  title as film_title,
  dense_rank() over(order by count(*) desc) as film_rank
 from film f
 join inventory i on f.film_id = i.film_id
 join rental r on i.inventory_id = r.inventory_id
 where year(rental_date) = 2005
 group by 1
)t
where film_rank <= 3
```
